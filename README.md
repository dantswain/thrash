# Thrash

An Elixir library for serialization and deserialization of
[Apache Thrift](https://thrift.apache.org/) messages. ðŸ¤˜

## Philosophy

Thrash is an attempt to provide faster serialization/deserialization
to/from Thrift's Binary protocols and to provide an API that is
idiomatic for Elixir applications.  Compared to the official Erlang
Thrift library, Thrash is significantly faster (see below) and works
with Elixir structs rather than Erlang records.

Thrash makes heavy use of binary pattern matching and uses Elixir
macros to flatten much of the branching logic that exists in the
Erlang library.  For example, we can use a macro to generate a single
binary match specification to extract the typed value of a field from
our message as opposed to first extracting the field number and then
looking up its type and then performing the appropriate value
extraction.

Thrash is geared towards use cases where Thrift is being used
primarily as a message format specification, as opposed to a service
platform.  That is, Thrash does not currently provide an
implementation of Thrift Server and may not plug easily into an
existing Thrift service without a server adapter.  On the other hand,
if you are using Thrift as a message specification within your own
services, Thrash can provide a significant speedup.

It should be possible to extend Thrash to plug into Thrift services
(i.e., provide a Thrift Server implementation).  I simply haven't put
any effort into implementing that because it doesn't fit my use case.

## Status

Thrash is very much still a work in progress.  I have been focusing on
implementing the functionality that I need.

* Many of the basic thrift data types are implemented: bool, double,
  i32, enum, i64, string, struct, and list.  Adding support for other
  data types should be relatively easy with the possible exceptions of
  map and set.

* I haven't finalized the API for reading from the thrift IDL, but it
  is coming along.

* I have been focused on Thrift Binary Protocol because that is what
  the official Erlang library implements and I want to be able to do
  benchmark comparisons.  I will eventually implement the Binary
  Accelerated Protocol, which is mostly the same as the Binary
  Protocol with some special cases.  The official Erlang library does
  not implement the Binary Accelerated Protocol.  I have no plans to
  implement other protocols, but would welcome pull requests.

* There is no implementation here for services or servers.  It should
  be possible to build something like that using Thrash.  Pull
  requests are welcomed.

* The code is currently very much a mess and needs to be
  refactored/cleaned up.  I've been focused on implementing the
  features I need and will revisit this soon.

## Benchmarks

Thrash is significantly faster at serialization/deserialization than
the official Erlang Thrift library for the Thrift Binary protocol.  In
the interest of full disclosure, this comparison is made using
[ThriftEx](https://github.com/dantswain/thrift_ex), which is an Elixir
adapter for the Erlang library that I wrote.  However, ThriftEx only
exposes the data structures generated by the Thrift generator - it
does not implement any of its own serialization or deserialization.

The bench directory in this project contains a simple benchmark for
comparing Thrash and Erlang Thrift library.  I'd welcome suggestions
on how to improve these benchmarks.

```
iex(1)> Bench.bench_thrift_ex
Benchmarking Thrift serialization
*** #Function<1.127410406/0 in Bench.bench_thrift_ex/0> ***
1.1 sec    32K iterations   34.59 Î¼s/op

Benchmarking Thrift deserialization
*** #Function<2.127410406/0 in Bench.bench_thrift_ex/0> ***
1.0 sec    16K iterations   64.37 Î¼s/op

Done
:ok
iex(2)> Bench.bench_thrash
Benchmarking Thrash serialization
*** #Function<4.127410406/0 in Bench.bench_thrash/0> ***
1.6 sec   262K iterations   6.23 Î¼s/op

Benchmarking Thrash deserialization
*** #Function<5.127410406/0 in Bench.bench_thrash/0> ***
1.7 sec   524K iterations   3.39 Î¼s/op

Done
:ok
```

According to these results, Thrash is about 5x faster for
serialization and about 18x faster for deserialization compared to the
official Erlang library.

## Usage

Since this is still very much work in progress, I have not published
anything to Hex and it doesn't make sense to write up careful usage
instructions when that could change with the next commit.  If you want
to pull down this repository and poke around, check out
`test/simple_struct.ex` to see how the API is currently being
used.

To build and run local development, you need to generate the ThriftEx
code for `test/thrash_test.exs` (used for benchmarking).  This should
be a matter of doing

```
mix deps.get
mix deps.compile
mix thrift --thrift-dir test/
mix compile
```
